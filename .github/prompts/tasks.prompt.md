# SaltShark 开发任务清单

**项目**: SaltShark - Salt Project Web 管理界面  
**开发方法**: 测试驱动开发 (TDD)  
**原则**: Red-Green-Refactor  
**版本**: v1.0  
**更新日期**: 2025-11-29

---

## 任务组织说明

### 任务格式

每个任务遵循以下格式：

```markdown
- [ ] **[模块]** 任务标题
  - **优先级**: P0/P1/P2/P3
  - **预计时间**: X 小时/天
  - **前置依赖**: 任务ID列表
  - **验收标准**:
    1. 测试覆盖率 ≥ 80%
    2. 所有测试通过
    3. 类型检查通过
    4. 代码审查通过
  - **TDD 步骤**:
    1. 编写失败的测试
    2. 实现最小代码使测试通过
    3. 重构优化代码
```

### 优先级定义

- **P0**: 阻塞性任务，必须最先完成
- **P1**: 核心功能，MVP 必需
- **P2**: 重要功能，增强用户体验
- **P3**: 优化功能，可延后

---

## Phase 1: 项目初始化和基础架构 (Week 1-2)

### 1.1 项目搭建

- [ ] **[基础]** TASK-001: 初始化项目目录结构
  - **优先级**: P0
  - **预计时间**: 2 小时
  - **前置依赖**: 无
  - **验收标准**:
    1. 创建标准 Python 项目结构
    2. 创建 Next.js 前端项目结构
    3. 配置 `.gitignore` 和 `.editorconfig`
    4. README.md 文档完整
  - **交付物**:
    ```
    /workspaces/saltshark/
    ├── backend/
    │   ├── app/
    │   ├── tests/
    │   ├── pyproject.toml
    │   └── README.md
    ├── frontend/
    │   ├── src/
    │   ├── package.json
    │   └── README.md
    ├── dev/
    │   ├── docker-compose.dev.yml
    │   └── scripts/
    └── docs/
    ```

- [ ] **[基础]** TASK-002: 配置 Python 开发环境
  - **优先级**: P0
  - **预计时间**: 3 小时
  - **前置依赖**: TASK-001
  - **验收标准**:
    1. UV 包管理器配置完成
    2. pyproject.toml 依赖定义完整
    3. Ruff 代码检查配置
    4. Mypy 类型检查配置
    5. Pytest 测试框架配置
    6. pre-commit hooks 配置
  - **TDD 步骤**:
    1. 编写测试验证工具链可用性
    2. 配置开发工具
    3. 运行测试确认环境正常

- [ ] **[基础]** TASK-003: 配置前端开发环境
  - **优先级**: P0
  - **预计时间**: 3 小时
  - **前置依赖**: TASK-001
  - **验收标准**:
    1. Next.js 16 (App Router) 项目初始化
    2. TypeScript 配置完成
    3. TailwindCSS 配置完成
    4. ESLint + Prettier 配置
    5. shadcn/ui 初始化
    6. 测试框架配置 (Vitest + Testing Library)
  - **交付物**:
    - `package.json` 依赖完整
    - `tsconfig.json` 配置正确
    - `tailwind.config.ts` 配置完成
    - `.eslintrc.json` 规则定义

- [ ] **[基础]** TASK-004: 搭建开发环境 Docker Compose
  - **优先级**: P0
  - **预计时间**: 4 小时
  - **前置依赖**: TASK-001
  - **验收标准**:
    1. PostgreSQL 容器配置正确
    2. Redis 容器配置正确
    3. OpenFGA 容器配置正确
    4. Keycloak 容器配置正确
    5. Salt Master 容器配置正确
    6. Mock 用户管理 API 容器配置正确
    7. 所有服务能正常启动和通信
  - **交付物**:
    - `dev/docker-compose.dev.yml`
    - `dev/salt/master.conf`
    - `dev/scripts/create-databases.sh`
    - `dev/mock/user-management-expectations.json`

---

### 1.2 数据库设计与 ORM

- [ ] **[数据库]** TASK-005: 定义 TortoiseORM 模型 - UserReference
  - **优先级**: P0
  - **预计时间**: 2 小时
  - **前置依赖**: TASK-002, TASK-004
  - **验收标准**:
    1. 测试覆盖率 100%
    2. 模型字段定义正确
    3. 索引定义完整
    4. 所有字段有类型提示
  - **TDD 步骤**:
    1. 编写模型创建/查询的测试
    2. 实现 UserReference 模型
    3. 运行测试验证
    4. 重构优化
  - **测试用例**:
    - 测试创建用户引用
    - 测试查询用户引用
    - 测试更新 last_active
    - 测试 first_seen 自动设置

- [ ] **[数据库]** TASK-006: 定义 TortoiseORM 模型 - Minion
  - **优先级**: P0
  - **预计时间**: 3 小时
  - **前置依赖**: TASK-002, TASK-004
  - **验收标准**:
    1. 测试覆盖率 100%
    2. JSONB 字段正确处理
    3. 状态枚举定义
    4. GIN 索引验证
  - **TDD 步骤**:
    1. 编写 Minion CRUD 测试
    2. 编写 Grains JSON 查询测试
    3. 实现 Minion 模型
    4. 验证索引性能
  - **测试用例**:
    - 测试创建 Minion
    - 测试更新 Grains
    - 测试按状态查询
    - 测试 Grains JSON 查询
    - 测试时间戳自动更新

- [ ] **[数据库]** TASK-007: 定义 TortoiseORM 模型 - Job
  - **优先级**: P0
  - **预计时间**: 3 小时
  - **前置依赖**: TASK-002, TASK-004, TASK-005
  - **验收标准**:
    1. 测试覆盖率 100%
    2. 外键关系正确
    3. JSONB 字段处理
    4. 状态转换验证
  - **TDD 步骤**:
    1. 编写 Job 生命周期测试
    2. 编写关联查询测试
    3. 实现 Job 模型
    4. 验证外键约束
  - **测试用例**:
    - 测试创建 Job
    - 测试关联 UserReference
    - 测试状态转换
    - 测试结果存储
    - 测试执行时间计算

- [ ] **[数据库]** TASK-008: 定义 TortoiseORM 模型 - AuditLog
  - **优先级**: P1
  - **预计时间**: 2 小时
  - **前置依赖**: TASK-002, TASK-004, TASK-005
  - **验收标准**:
    1. 测试覆盖率 100%
    2. 所有审计字段完整
    3. 索引优化查询性能
  - **TDD 步骤**:
    1. 编写审计日志创建测试
    2. 编写查询和过滤测试
    3. 实现 AuditLog 模型
    4. 验证性能
  - **测试用例**:
    - 测试创建审计日志
    - 测试按用户查询
    - 测试按时间范围查询
    - 测试按操作类型查询

- [ ] **[数据库]** TASK-009: 配置 Aerich 数据库迁移
  - **优先级**: P0
  - **预计时间**: 2 小时
  - **前置依赖**: TASK-005, TASK-006, TASK-007, TASK-008
  - **验收标准**:
    1. Aerich 配置正确
    2. 初始迁移文件生成
    3. 迁移可以正常应用
    4. 迁移可以正常回滚
  - **TDD 步骤**:
    1. 编写迁移测试脚本
    2. 配置 Aerich
    3. 生成并应用迁移
    4. 验证数据库 schema
  - **交付物**:
    - `pyproject.toml` Aerich 配置
    - `migrations/` 目录
    - 初始迁移文件

---

### 1.3 认证与授权基础

- [ ] **[认证]** TASK-010: 集成 Keycloak 认证 - 后端配置
  - **优先级**: P0
  - **预计时间**: 4 小时
  - **前置依赖**: TASK-002, TASK-004
  - **验收标准**:
    1. JWT 验证中间件测试通过
    2. 用户信息提取测试通过
    3. 令牌刷新测试通过
    4. 错误处理完整
  - **TDD 步骤**:
    1. 编写 JWT 验证测试（有效/无效/过期）
    2. 编写用户信息提取测试
    3. 实现认证中间件
    4. 验证与 Keycloak 集成
  - **测试用例**:
    - 测试有效 JWT 令牌验证
    - 测试无效令牌拒绝
    - 测试过期令牌拒绝
    - 测试用户 ID 提取
    - 测试刷新令牌

- [ ] **[认证]** TASK-011: 集成 Auth.js (NextAuth) - 前端配置
  - **优先级**: P0
  - **预计时间**: 4 小时
  - **前置依赖**: TASK-003, TASK-004
  - **验收标准**:
    1. Auth.js 配置正确
    2. Keycloak Provider 配置
    3. 会话管理测试通过
    4. 登录/登出流程测试通过
  - **TDD 步骤**:
    1. 编写认证流程测试
    2. 配置 Auth.js
    3. 实现登录/登出页面
    4. 验证会话持久化
  - **测试用例**:
    - 测试登录重定向
    - 测试会话创建
    - 测试会话刷新
    - 测试登出清理
  - **交付物**:
    - `app/api/auth/[...nextauth]/route.ts`
    - `lib/auth.ts`
    - 登录页面组件

- [ ] **[权限]** TASK-012: 初始化 OpenFGA 权限模型
  - **优先级**: P0
  - **预计时间**: 4 小时
  - **前置依赖**: TASK-002, TASK-004
  - **验收标准**:
    1. OpenFGA DSL 模型定义正确
    2. 模型上传测试通过
    3. 基本权限关系创建测试通过
    4. 权限检查测试通过
  - **TDD 步骤**:
    1. 编写权限模型验证测试
    2. 编写权限关系测试
    3. 实现模型定义和初始化
    4. 验证权限检查逻辑
  - **测试用例**:
    - 测试 super_admin 角色权限
    - 测试 operator 角色权限
    - 测试 viewer 角色权限
    - 测试权限继承
  - **交付物**:
    - `config/openfga_model.fga`
    - 权限模型文档

- [ ] **[权限]** TASK-013: 实现 PermissionService
  - **优先级**: P0
  - **预计时间**: 4 小时
  - **前置依赖**: TASK-012
  - **验收标准**:
    1. 测试覆盖率 ≥ 90%
    2. 所有权限检查方法测试通过
    3. 批量权限检查测试通过
    4. 错误处理完整
  - **TDD 步骤**:
    1. 编写权限检查测试（各种场景）
    2. 编写批量检查测试
    3. 实现 PermissionService
    4. 优化性能
  - **测试用例**:
    - 测试单个权限检查
    - 测试批量权限检查
    - 测试角色分配
    - 测试权限撤销
    - 测试 OpenFGA 连接失败降级
  - **交付物**:
    - `app/services/permission.py`
    - 单元测试文件

- [ ] **[权限]** TASK-014: 实现权限初始化服务
  - **优先级**: P0
  - **预计时间**: 3 小时
  - **前置依赖**: TASK-013
  - **验收标准**:
    1. 配置文件解析测试通过
    2. 初始管理员创建测试通过
    3. 幂等性测试通过（重复运行不出错）
    4. 错误处理完整
  - **TDD 步骤**:
    1. 编写配置加载测试
    2. 编写权限初始化测试
    3. 实现 PermissionInitializer
    4. 验证应用启动集成
  - **测试用例**:
    - 测试首次初始化创建超管
    - 测试重复初始化不重复创建
    - 测试配置文件格式错误处理
    - 测试 OpenFGA 不可用时的降级
  - **交付物**:
    - `app/core/permission_initializer.py`
    - `config/permissions.yaml`

- [ ] **[权限]** TASK-015: 实现权限检查中间件
  - **优先级**: P0
  - **预计时间**: 3 小时
  - **前置依赖**: TASK-013, TASK-010
  - **验收标准**:
    1. 测试覆盖率 ≥ 90%
    2. FastAPI 依赖注入测试通过
    3. 权限拒绝返回 403
    4. 审计日志记录测试通过
  - **TDD 步骤**:
    1. 编写权限中间件测试
    2. 编写依赖注入测试
    3. 实现 require_permission 依赖
    4. 集成审计日志
  - **测试用例**:
    - 测试有权限的请求通过
    - 测试无权限的请求被拒绝
    - 测试超级管理员绕过检查
    - 测试审计日志记录
  - **交付物**:
    - `app/core/dependencies.py`
    - `app/middleware/permission.py`

---

## Phase 2: 核心功能开发 (Week 3-6)

### 2.1 用户系统集成

- [ ] **[用户]** TASK-016: 实现用户管理系统 API 客户端
  - **优先级**: P0
  - **预计时间**: 3 小时
  - **前置依赖**: TASK-002
  - **验收标准**:
    1. 测试覆盖率 ≥ 90%
    2. 单用户查询测试通过
    3. 批量查询测试通过
    4. HTTP 错误处理测试通过
  - **TDD 步骤**:
    1. 编写 API 客户端测试（Mock HTTP 响应）
    2. 实现 UserManagementClient
    3. 验证错误重试逻辑
    4. 性能测试
  - **测试用例**:
    - 测试单用户查询成功
    - 测试批量查询成功
    - 测试 API 超时处理
    - 测试 API 404 处理
    - 测试网络错误重试
  - **交付物**:
    - `app/clients/user_management.py`
    - Mock 测试数据

- [ ] **[用户]** TASK-017: 实现用户信息缓存服务
  - **优先级**: P1
  - **预计时间**: 3 小时
  - **前置依赖**: TASK-016, TASK-004
  - **验收标准**:
    1. 测试覆盖率 ≥ 90%
    2. 缓存命中测试通过
    3. 缓存失效测试通过
    4. 批量查询优化测试通过
  - **TDD 步骤**:
    1. 编写缓存逻辑测试
    2. 实现 UserInfoService
    3. 验证 Redis 集成
    4. 性能基准测试
  - **测试用例**:
    - 测试首次查询（缓存未命中）
    - 测试缓存命中
    - 测试缓存过期自动刷新
    - 测试批量查询去重
    - 测试 Redis 不可用降级
  - **交付物**:
    - `app/services/user_info.py`
    - 缓存策略文档

- [ ] **[用户]** TASK-018: 实现用户信息降级策略
  - **优先级**: P1
  - **预计时间**: 2 小时
  - **前置依赖**: TASK-017
  - **验收标准**:
    1. 降级逻辑测试通过
    2. 告警触发测试通过
    3. 返回默认值测试通过
  - **TDD 步骤**:
    1. 编写降级场景测试
    2. 实现降级逻辑
    3. 集成告警系统
    4. 验证用户体验
  - **测试用例**:
    - 测试 API 不可用时返回缓存
    - 测试缓存也不可用时返回 user_id
    - 测试降级事件记录
  - **交付物**:
    - 降级逻辑代码
    - 告警配置

---

### 2.2 Salt API 集成

- [ ] **[Salt]** TASK-019: 实现 Salt API 客户端 - 认证
  - **优先级**: P0
  - **预计时间**: 3 小时
  - **前置依赖**: TASK-002, TASK-004
  - **验收标准**:
    1. 测试覆盖率 ≥ 90%
    2. PAM 认证测试通过
    3. Token 管理测试通过
    4. Token 自动刷新测试通过
  - **TDD 步骤**:
    1. 编写认证流程测试（Mock Salt API）
    2. 实现 SaltAPIClient 认证部分
    3. 验证 Token 持久化
    4. 测试并发认证
  - **测试用例**:
    - 测试首次登录获取 Token
    - 测试 Token 过期自动刷新
    - 测试认证失败处理
    - 测试并发请求复用 Token
  - **交付物**:
    - `app/clients/salt_api.py` (部分)
    - 认证配置

- [ ] **[Salt]** TASK-020: 实现 Salt API 客户端 - Minion 管理
  - **优先级**: P0
  - **预计时间**: 4 小时
  - **前置依赖**: TASK-019
  - **验收标准**:
    1. 测试覆盖率 ≥ 90%
    2. 所有 Minion 操作测试通过
    3. Key 管理测试通过
    4. Grains 查询测试通过
  - **TDD 步骤**:
    1. 编写 Minion API 测试
    2. 实现 Minion 相关方法
    3. 验证数据解析
    4. 错误处理测试
  - **测试用例**:
    - 测试列出所有 Minion
    - 测试接受/拒绝 Key
    - 测试删除 Key
    - 测试查询 Grains
    - 测试 test.ping
  - **交付物**:
    - `app/clients/salt_api.py` (扩展)
    - API 响应模型

- [ ] **[Salt]** TASK-021: 实现 Salt API 客户端 - 命令执行
  - **优先级**: P0
  - **预计时间**: 4 小时
  - **前置依赖**: TASK-019
  - **验收标准**:
    1. 测试覆盖率 ≥ 90%
    2. 异步执行测试通过
    3. 结果查询测试通过
    4. Targeting 测试通过
  - **TDD 步骤**:
    1. 编写命令执行测试
    2. 实现 execute_command 方法
    3. 验证 JID 返回
    4. 测试各种 Targeting 方式
  - **测试用例**:
    - 测试 cmd.run 执行
    - 测试 Glob targeting
    - 测试 Grain targeting
    - 测试 Compound targeting
    - 测试异步执行返回 JID
  - **交付物**:
    - `app/clients/salt_api.py` (扩展)
    - Targeting 模型

- [ ] **[Salt]** TASK-022: 实现 Salt API 客户端 - Job 查询
  - **优先级**: P0
  - **预计时间**: 3 小时
  - **前置依赖**: TASK-019
  - **验收标准**:
    1. 测试覆盖率 ≥ 90%
    2. Job 查询测试通过
    3. Job 结果解析测试通过
    4. Job 列表分页测试通过
  - **TDD 步骤**:
    1. 编写 Job 查询测试
    2. 实现 Job 相关方法
    3. 验证结果解析
    4. 性能优化
  - **测试用例**:
    - 测试按 JID 查询 Job
    - 测试查询 Job 结果
    - 测试列出所有 Job
    - 测试过滤运行中的 Job
  - **交付物**:
    - `app/clients/salt_api.py` (完成)
    - Job 响应模型

- [ ] **[Salt]** TASK-023: 实现 Salt Event Bus 监听器
  - **优先级**: P1
  - **预计时间**: 4 小时
  - **前置依赖**: TASK-019
  - **验收标准**:
    1. 测试覆盖率 ≥ 80%
    2. WebSocket 连接测试通过
    3. 事件解析测试通过
    4. 重连机制测试通过
  - **TDD 步骤**:
    1. 编写事件监听测试
    2. 实现 SaltEventListener
    3. 验证事件分发
    4. 测试断线重连
  - **测试用例**:
    - 测试连接 Salt Event Bus
    - 测试接收 Job 事件
    - 测试事件过滤
    - 测试自动重连
  - **交付物**:
    - `app/services/salt_events.py`
    - 事件处理器注册机制

---

### 2.3 Minion 管理服务

- [ ] **[Minion]** TASK-024: 实现 MinionService - 数据同步
  - **优先级**: P0
  - **预计时间**: 4 小时
  - **前置依赖**: TASK-020, TASK-006
  - **验收标准**:
    1. 测试覆盖率 ≥ 90%
    2. 从 Salt 同步 Minion 测试通过
    3. Grains 更新测试通过
    4. 状态更新测试通过
  - **TDD 步骤**:
    1. 编写数据同步测试
    2. 实现 sync_minions 方法
    3. 验证数据库更新
    4. 性能优化（批量操作）
  - **测试用例**:
    - 测试首次同步创建 Minion
    - 测试更新已存在 Minion
    - 测试 Grains 数据存储
    - 测试批量同步性能
  - **交付物**:
    - `app/services/minion.py` (部分)
    - 同步任务定义

- [ ] **[Minion]** TASK-025: 实现 MinionService - CRUD 操作
  - **优先级**: P0
  - **预计时间**: 3 小时
  - **前置依赖**: TASK-024
  - **验收标准**:
    1. 测试覆盖率 ≥ 90%
    2. 所有 CRUD 操作测试通过
    3. 权限检查集成测试通过
    4. 错误处理完整
  - **TDD 步骤**:
    1. 编写 CRUD 测试
    2. 实现 get/list/create/update 方法
    3. 集成权限检查
    4. 验证审计日志
  - **测试用例**:
    - 测试获取单个 Minion
    - 测试列出 Minion（分页、过滤）
    - 测试更新 Minion
    - 测试删除 Minion（软删除）
  - **交付物**:
    - `app/services/minion.py` (扩展)

- [ ] **[Minion]** TASK-026: 实现 MinionService - Key 管理
  - **优先级**: P0
  - **预计时间**: 3 小时
  - **前置依赖**: TASK-024, TASK-020
  - **验收标准**:
    1. 测试覆盖率 ≥ 90%
    2. Key 操作测试通过
    3. 批量操作测试通过
    4. 审计日志记录测试通过
  - **TDD 步骤**:
    1. 编写 Key 管理测试
    2. 实现 accept/reject/delete_key 方法
    3. 集成审计日志
    4. 验证权限控制
  - **测试用例**:
    - 测试接受单个 Key
    - 测试批量接受 Key
    - 测试拒绝 Key
    - 测试删除 Key
    - 测试权限不足拒绝操作
  - **交付物**:
    - `app/services/minion.py` (完成)

- [ ] **[Minion]** TASK-027: 实现 Minion API 端点 - 列表查询
  - **优先级**: P0
  - **预计时间**: 3 小时
  - **前置依赖**: TASK-025
  - **验收标准**:
    1. 测试覆盖率 ≥ 90%
    2. API 集成测试通过
    3. 分页测试通过
    4. 过滤和排序测试通过
  - **TDD 步骤**:
    1. 编写 API 端点测试
    2. 实现 GET /api/v1/minions
    3. 验证响应格式
    4. 性能测试
  - **测试用例**:
    - 测试无参数查询
    - 测试分页参数
    - 测试搜索过滤
    - 测试状态过滤
    - 测试排序
  - **交付物**:
    - `app/api/v1/minions.py` (部分)
    - API 响应模型

- [ ] **[Minion]** TASK-028: 实现 Minion API 端点 - 详情查询
  - **优先级**: P0
  - **预计时间**: 2 小时
  - **前置依赖**: TASK-025
  - **验收标准**:
    1. 测试覆盖率 ≥ 90%
    2. API 测试通过
    3. 权限检查测试通过
    4. 404 处理测试通过
  - **TDD 步骤**:
    1. 编写详情端点测试
    2. 实现 GET /api/v1/minions/{id}
    3. 验证权限集成
    4. 错误处理
  - **测试用例**:
    - 测试获取存在的 Minion
    - 测试获取不存在的 Minion (404)
    - 测试无权限访问 (403)
  - **交付物**:
    - `app/api/v1/minions.py` (扩展)

- [ ] **[Minion]** TASK-029: 实现 Minion API 端点 - Key 管理
  - **优先级**: P0
  - **预计时间**: 3 小时
  - **前置依赖**: TASK-026
  - **验收标准**:
    1. 测试覆盖率 ≥ 90%
    2. 所有 Key 操作 API 测试通过
    3. 批量操作测试通过
    4. 权限检查测试通过
  - **TDD 步骤**:
    1. 编写 Key 管理 API 测试
    2. 实现 Key 相关端点
    3. 验证审计日志
    4. 错误处理
  - **测试用例**:
    - 测试接受 Key API
    - 测试批量接受 API
    - 测试拒绝/删除 Key
    - 测试权限不足返回 403
  - **交付物**:
    - `app/api/v1/minions.py` (扩展)

- [ ] **[Minion]** TASK-030: 实现 Minion API 端点 - 刷新数据
  - **优先级**: P1
  - **预计时间**: 2 小时
  - **前置依赖**: TASK-024
  - **验收标准**:
    1. 测试覆盖率 ≥ 90%
    2. 刷新 API 测试通过
    3. 异步处理测试通过
  - **TDD 步骤**:
    1. 编写刷新端点测试
    2. 实现 POST /api/v1/minions/{id}/refresh
    3. 验证异步任务
    4. 响应时间优化
  - **测试用例**:
    - 测试触发刷新
    - 测试刷新完成通知
    - 测试 Minion 离线时的处理
  - **交付物**:
    - `app/api/v1/minions.py` (完成)

---

### 2.4 Job 管理服务

- [ ] **[Job]** TASK-031: 实现 JobService - 任务执行
  - **优先级**: P0
  - **预计时间**: 4 小时
  - **前置依赖**: TASK-021, TASK-007
  - **验收标准**:
    1. 测试覆盖率 ≥ 90%
    2. 任务提交测试通过
    3. JID 返回测试通过
    4. 数据库记录测试通过
  - **TDD 步骤**:
    1. 编写任务执行测试
    2. 实现 execute_job 方法
    3. 验证数据库记录
    4. 验证权限检查
  - **测试用例**:
    - 测试提交简单命令
    - 测试提交复杂命令（带参数）
    - 测试各种 Targeting
    - 测试权限检查集成
    - 测试审计日志记录
  - **交付物**:
    - `app/services/job.py` (部分)

- [ ] **[Job]** TASK-032: 实现 JobService - 结果获取
  - **优先级**: P0
  - **预计时间**: 3 小时
  - **前置依赖**: TASK-022, TASK-031
  - **验收标准**:
    1. 测试覆盖率 ≥ 90%
    2. 结果查询测试通过
    3. 结果解析测试通过
    4. 缓存策略测试通过
  - **TDD 步骤**:
    1. 编写结果查询测试
    2. 实现 get_job_result 方法
    3. 验证结果存储
    4. 实现缓存逻辑
  - **测试用例**:
    - 测试查询运行中 Job
    - 测试查询已完成 Job
    - 测试结果缓存
    - 测试多次查询不重复请求
  - **交付物**:
    - `app/services/job.py` (扩展)

- [ ] **[Job]** TASK-033: 实现 JobService - 任务列表
  - **优先级**: P0
  - **预计时间**: 3 小时
  - **前置依赖**: TASK-031
  - **验收标准**:
    1. 测试覆盖率 ≥ 90%
    2. 列表查询测试通过
    3. 分页测试通过
    4. 过滤测试通过
  - **TDD 步骤**:
    1. 编写列表查询测试
    2. 实现 list_jobs 方法
    3. 验证权限过滤
    4. 性能优化
  - **测试用例**:
    - 测试列出所有 Job
    - 测试按用户过滤
    - 测试按状态过滤
    - 测试按时间范围过滤
    - 测试分页
  - **交付物**:
    - `app/services/job.py` (完成)

- [ ] **[Job]** TASK-034: 实现 Job API 端点 - 执行命令
  - **优先级**: P0
  - **预计时间**: 3 小时
  - **前置依赖**: TASK-031
  - **验收标准**:
    1. 测试覆盖率 ≥ 90%
    2. API 测试通过
    3. 请求验证测试通过
    4. 权限检查测试通过
  - **TDD 步骤**:
    1. 编写执行 API 测试
    2. 实现 POST /api/v1/jobs/execute
    3. 验证请求参数
    4. 验证响应格式
  - **测试用例**:
    - 测试有效请求
    - 测试无效参数拒绝
    - 测试权限不足拒绝
    - 测试返回 JID
  - **交付物**:
    - `app/api/v1/jobs.py` (部分)
    - 请求/响应模型

- [ ] **[Job]** TASK-035: 实现 Job API 端点 - 查询结果
  - **优先级**: P0
  - **预计时间**: 2 小时
  - **前置依赖**: TASK-032
  - **验收标准**:
    1. 测试覆盖率 ≥ 90%
    2. API 测试通过
    3. 实时状态测试通过
  - **TDD 步骤**:
    1. 编写结果查询 API 测试
    2. 实现 GET /api/v1/jobs/{jid}
    3. 验证响应格式
    4. 验证权限检查
  - **测试用例**:
    - 测试查询存在的 Job
    - 测试查询不存在的 Job (404)
    - 测试无权限查询 (403)
  - **交付物**:
    - `app/api/v1/jobs.py` (扩展)

- [ ] **[Job]** TASK-036: 实现 Job API 端点 - 列表查询
  - **优先级**: P0
  - **预计时间**: 3 小时
  - **前置依赖**: TASK-033
  - **验收标准**:
    1. 测试覆盖率 ≥ 90%
    2. API 测试通过
    3. 过滤和排序测试通过
  - **TDD 步骤**:
    1. 编写列表 API 测试
    2. 实现 GET /api/v1/jobs
    3. 验证分页和过滤
    4. 性能测试
  - **测试用例**:
    - 测试列出所有 Job
    - 测试分页
    - 测试按状态过滤
    - 测试按时间排序
  - **交付物**:
    - `app/api/v1/jobs.py` (完成)

---

## Phase 3: 审计与权限管理 (Week 5-6)

### 3.1 审计日志

- [ ] **[审计]** TASK-037: 实现 AuditLogService - 日志记录
  - **优先级**: P1
  - **预计时间**: 3 小时
  - **前置依赖**: TASK-008, TASK-005
  - **验收标准**:
    1. 测试覆盖率 ≥ 90%
    2. 日志创建测试通过
    3. 上下文信息捕获测试通过
    4. 异步写入测试通过
  - **TDD 步骤**:
    1. 编写日志记录测试
    2. 实现 log_action 方法
    3. 验证数据完整性
    4. 性能优化（批量写入）
  - **测试用例**:
    - 测试记录成功操作
    - 测试记录失败操作
    - 测试捕获请求上下文
    - 测试异步写入不阻塞请求
  - **交付物**:
    - `app/services/audit.py` (部分)

- [ ] **[审计]** TASK-038: 实现 AuditLogService - 日志查询
  - **优先级**: P1
  - **预计时间**: 3 小时
  - **前置依赖**: TASK-037
  - **验收标准**:
    1. 测试覆盖率 ≥ 90%
    2. 多维度查询测试通过
    3. 分页测试通过
    4. 性能优化测试通过
  - **TDD 步骤**:
    1. 编写查询测试
    2. 实现 query_logs 方法
    3. 验证索引使用
    4. 大数据量测试
  - **测试用例**:
    - 测试按用户查询
    - 测试按时间范围查询
    - 测试按操作类型查询
    - 测试按资源查询
    - 测试复合查询
  - **交付物**:
    - `app/services/audit.py` (完成)

- [ ] **[审计]** TASK-039: 实现审计日志中间件
  - **优先级**: P1
  - **预计时间**: 3 小时
  - **前置依赖**: TASK-037
  - **验收标准**:
    1. 测试覆盖率 ≥ 90%
    2. 自动拦截测试通过
    3. 请求/响应捕获测试通过
    4. 性能影响 < 5ms
  - **TDD 步骤**:
    1. 编写中间件测试
    2. 实现审计中间件
    3. 验证自动记录
    4. 性能基准测试
  - **测试用例**:
    - 测试自动记录所有 API 请求
    - 测试捕获请求参数
    - 测试捕获响应状态
    - 测试过滤敏感信息
  - **交付物**:
    - `app/middleware/audit.py`
    - 敏感字段配置

- [ ] **[审计]** TASK-040: 实现审计日志 API 端点
  - **优先级**: P1
  - **预计时间**: 3 小时
  - **前置依赖**: TASK-038
  - **验收标准**:
    1. 测试覆盖率 ≥ 90%
    2. API 测试通过
    3. 权限检查测试通过（仅超管）
    4. 导出功能测试通过
  - **TDD 步骤**:
    1. 编写 API 测试
    2. 实现 GET /api/v1/audit-logs
    3. 实现导出功能
    4. 验证权限控制
  - **测试用例**:
    - 测试超管查询所有日志
    - 测试普通用户查询自己的日志
    - 测试导出 CSV
    - 测试导出 JSON
  - **交付物**:
    - `app/api/v1/audit.py`
    - 导出功能实现

---

### 3.2 权限管理界面（后端）

- [ ] **[权限]** TASK-041: 实现权限管理 Service - 用户列表
  - **优先级**: P1
  - **预计时间**: 3 小时
  - **前置依赖**: TASK-013, TASK-017
  - **验收标准**:
    1. 测试覆盖率 ≥ 90%
    2. 用户列表查询测试通过
    3. 用户信息聚合测试通过
    4. 权限缓存测试通过
  - **TDD 步骤**:
    1. 编写用户列表测试
    2. 实现 list_users_with_roles 方法
    3. 集成用户信息服务
    4. 性能优化
  - **测试用例**:
    - 测试列出所有用户
    - 测试显示用户角色
    - 测试用户信息聚合
    - 测试分页和搜索
  - **交付物**:
    - `app/services/permission_management.py` (部分)

- [ ] **[权限]** TASK-042: 实现权限管理 Service - 角色分配
  - **优先级**: P1
  - **预计时间**: 3 小时
  - **前置依赖**: TASK-041
  - **验收标准**:
    1. 测试覆盖率 ≥ 90%
    2. 角色分配测试通过
    3. 角色撤销测试通过
    4. 审计日志测试通过
  - **TDD 步骤**:
    1. 编写角色管理测试
    2. 实现 assign_role/revoke_role 方法
    3. 验证审计日志
    4. 验证权限检查
  - **测试用例**:
    - 测试分配超管角色
    - 测试分配运维角色
    - 测试撤销角色
    - 测试不能撤销自己的超管
    - 测试审计日志记录
  - **交付物**:
    - `app/services/permission_management.py` (完成)

- [ ] **[权限]** TASK-043: 实现权限管理 API 端点
  - **优先级**: P1
  - **预计时间**: 3 小时
  - **前置依赖**: TASK-042
  - **验收标准**:
    1. 测试覆盖率 ≥ 90%
    2. 所有 API 测试通过
    3. 权限检查测试通过（仅超管）
  - **TDD 步骤**:
    1. 编写 API 测试
    2. 实现权限管理端点
    3. 验证权限控制
    4. 错误处理
  - **测试用例**:
    - 测试列出用户 API
    - 测试分配角色 API
    - 测试批量分配 API
    - 测试非超管访问拒绝
  - **交付物**:
    - `app/api/v1/permissions.py`
    - 权限管理 API 文档

---

### 3.3 Dashboard 统计

- [ ] **[Dashboard]** TASK-044: 实现 DashboardService - 统计数据
  - **优先级**: P1
  - **预计时间**: 3 小时
  - **前置依赖**: TASK-025, TASK-033
  - **验收标准**:
    1. 测试覆盖率 ≥ 90%
    2. 统计查询测试通过
    3. 缓存策略测试通过
    4. 性能优化测试通过
  - **TDD 步骤**:
    1. 编写统计查询测试
    2. 实现 get_statistics 方法
    3. 实现缓存逻辑
    4. 性能基准测试
  - **测试用例**:
    - 测试 Minion 统计
    - 测试 Job 统计
    - 测试在线率计算
    - 测试缓存有效期
  - **交付物**:
    - `app/services/dashboard.py`

- [ ] **[Dashboard]** TASK-045: 实现 Dashboard API 端点
  - **优先级**: P1
  - **预计时间**: 2 小时
  - **前置依赖**: TASK-044
  - **验收标准**:
    1. 测试覆盖率 ≥ 90%
    2. API 测试通过
    3. 响应时间 < 200ms
  - **TDD 步骤**:
    1. 编写 API 测试
    2. 实现 GET /api/v1/dashboard
    3. 验证缓存头
    4. 性能测试
  - **测试用例**:
    - 测试获取 Dashboard 数据
    - 测试缓存响应
    - 测试权限检查
  - **交付物**:
    - `app/api/v1/dashboard.py`

---

## Phase 4: 前端开发 (Week 7-12)

### 4.1 前端基础设施

- [ ] **[前端]** TASK-046: 设置 shadcn/ui 组件库
  - **优先级**: P0
  - **预计时间**: 3 小时
  - **前置依赖**: TASK-003
  - **验收标准**:
    1. shadcn/ui 初始化完成
    2. 基础组件安装测试通过
    3. 主题配置完成
    4. 组件测试通过
  - **TDD 步骤**:
    1. 编写组件渲染测试
    2. 初始化 shadcn/ui
    3. 配置主题变量
    4. 测试组件可用性
  - **测试用例**:
    - 测试 Button 组件渲染
    - 测试 Input 组件交互
    - 测试 Table 组件数据绑定
    - 测试深色模式切换
  - **交付物**:
    - `components/ui/` 目录
    - 主题配置文件
    - 组件故事书（Storybook）

- [ ] **[前端]** TASK-047: 实现 API 客户端层
  - **优先级**: P0
  - **预计时间**: 4 小时
  - **前置依赖**: TASK-003
  - **验收标准**:
    1. 测试覆盖率 ≥ 90%
    2. HTTP 客户端测试通过
    3. 错误处理测试通过
    4. 认证集成测试通过
  - **TDD 步骤**:
    1. 编写 API 客户端测试
    2. 实现 API 客户端封装
    3. 集成认证 Token
    4. 错误处理和重试
  - **测试用例**:
    - 测试 GET 请求
    - 测试 POST 请求
    - 测试自动添加 Token
    - 测试 401 自动刷新 Token
    - 测试网络错误重试
  - **交付物**:
    - `lib/api-client.ts`
    - API 类型定义

- [ ] **[前端]** TASK-048: 实现 React Query 配置
  - **优先级**: P0
  - **预计时间**: 2 小时
  - **前置依赖**: TASK-047
  - **验收标准**:
    1. React Query 配置正确
    2. 缓存策略定义
    3. 错误边界测试通过
  - **TDD 步骤**:
    1. 编写查询测试
    2. 配置 QueryClient
    3. 实现错误边界
    4. 验证缓存行为
  - **测试用例**:
    - 测试数据缓存
    - 测试自动重新获取
    - 测试错误处理
  - **交付物**:
    - `lib/react-query.tsx`
    - Query hooks 模板

- [ ] **[前端]** TASK-049: 实现 Zustand 状态管理
  - **优先级**: P0
  - **预计时间**: 3 小时
  - **前置依赖**: TASK-003
  - **验收标准**:
    1. 测试覆盖率 ≥ 90%
    2. Store 定义测试通过
    3. 持久化测试通过
  - **TDD 步骤**:
    1. 编写 Store 测试
    2. 实现全局状态 Store
    3. 配置持久化
    4. 验证状态同步
  - **测试用例**:
    - 测试 Store 创建
    - 测试状态更新
    - 测试持久化存储
    - 测试跨组件状态共享
  - **交付物**:
    - `store/` 目录
    - 各模块 Store 定义

---

### 4.2 认证与路由

- [ ] **[前端]** TASK-050: 实现登录页面
  - **优先级**: P0
  - **预计时间**: 3 小时
  - **前置依赖**: TASK-011, TASK-046
  - **验收标准**:
    1. 组件测试覆盖率 ≥ 90%
    2. 登录流程测试通过
    3. 错误处理测试通过
  - **TDD 步骤**:
    1. 编写登录组件测试
    2. 实现登录页面 UI
    3. 集成 Auth.js
    4. 验证重定向逻辑
  - **测试用例**:
    - 测试点击登录按钮
    - 测试 Keycloak 重定向
    - 测试登录成功跳转
    - 测试登录失败提示
  - **交付物**:
    - `app/login/page.tsx`
    - 登录样式

- [ ] **[前端]** TASK-051: 实现路由守卫和布局
  - **优先级**: P0
  - **预计时间**: 3 小时
  - **前置依赖**: TASK-050
  - **验收标准**:
    1. 认证守卫测试通过
    2. 未登录重定向测试通过
    3. 布局渲染测试通过
  - **TDD 步骤**:
    1. 编写路由守卫测试
    2. 实现认证中间件
    3. 实现主布局
    4. 验证导航
  - **测试用例**:
    - 测试未登录访问保护路由
    - 测试登录后访问
    - 测试布局组件渲染
  - **交付物**:
    - `middleware.ts`
    - `app/layout.tsx`
    - 导航组件

---

### 4.3 Minion 管理界面

- [ ] **[前端]** TASK-052: 实现 Minion 列表页面
  - **优先级**: P0
  - **预计时间**: 4 小时
  - **前置依赖**: TASK-048, TASK-051
  - **验收标准**:
    1. 组件测试覆盖率 ≥ 90%
    2. 数据加载测试通过
    3. 分页测试通过
    4. 交互测试通过
  - **TDD 步骤**:
    1. 编写列表组件测试
    2. 实现 Minion 列表 UI
    3. 集成 React Query
    4. 实现分页和过滤
  - **测试用例**:
    - 测试加载状态显示
    - 测试数据表格渲染
    - 测试分页切换
    - 测试搜索过滤
    - 测试状态筛选
  - **交付物**:
    - `app/minions/page.tsx`
    - `components/minion-table.tsx`
    - Minion hooks

- [ ] **[前端]** TASK-053: 实现 Minion 详情页面
  - **优先级**: P0
  - **预计时间**: 3 小时
  - **前置依赖**: TASK-052
  - **验收标准**:
    1. 组件测试覆盖率 ≥ 90%
    2. 详情展示测试通过
    3. Tab 切换测试通过
  - **TDD 步骤**:
    1. 编写详情组件测试
    2. 实现详情页 UI
    3. 实现 Grains 展示
    4. 实现历史记录
  - **测试用例**:
    - 测试基本信息展示
    - 测试 Grains JSON 渲染
    - 测试 Tab 切换
    - 测试 404 处理
  - **交付物**:
    - `app/minions/[id]/page.tsx`
    - `components/minion-details.tsx`
    - JSON 查看器组件

- [ ] **[前端]** TASK-054: 实现 Minion Key 管理界面
  - **优先级**: P0
  - **预计时间**: 3 小时
  - **前置依赖**: TASK-052
  - **验收标准**:
    1. 组件测试覆盖率 ≥ 90%
    2. 批量操作测试通过
    3. 确认对话框测试通过
  - **TDD 步骤**:
    1. 编写 Key 管理组件测试
    2. 实现 Key 管理 UI
    3. 实现批量选择
    4. 实现确认对话框
  - **测试用例**:
    - 测试选择多个 Minion
    - 测试批量接受 Key
    - 测试确认对话框
    - 测试操作成功提示
  - **交付物**:
    - `components/minion-key-manager.tsx`
    - 确认对话框组件

---

### 4.4 远程执行界面

- [ ] **[前端]** TASK-055: 实现命令执行表单
  - **优先级**: P0
  - **预计时间**: 4 小时
  - **前置依赖**: TASK-048, TASK-051
  - **验收标准**:
    1. 组件测试覆盖率 ≥ 90%
    2. 表单验证测试通过
    3. 目标选择测试通过
  - **TDD 步骤**:
    1. 编写表单组件测试
    2. 实现命令执行表单
    3. 实现 Targeting 选择器
    4. 集成 React Hook Form
  - **测试用例**:
    - 测试表单字段渲染
    - 测试表单验证
    - 测试 Targeting 切换
    - 测试提交命令
  - **交付物**:
    - `app/execute/page.tsx`
    - `components/command-form.tsx`
    - `components/target-selector.tsx`

- [ ] **[前端]** TASK-056: 实现实时执行结果展示
  - **优先级**: P0
  - **预计时间**: 4 小时
  - **前置依赖**: TASK-055
  - **验收标准**:
    1. 组件测试覆盖率 ≥ 90%
    2. 实时更新测试通过
    3. 结果格式化测试通过
  - **TDD 步骤**:
    1. 编写结果组件测试
    2. 实现结果展示组件
    3. 集成 WebSocket
    4. 实现自动刷新
  - **测试用例**:
    - 测试加载状态
    - 测试进度显示
    - 测试结果分组
    - 测试成功/失败标识
  - **交付物**:
    - `components/execution-results.tsx`
    - WebSocket hook

- [ ] **[前端]** TASK-057: 实现命令模板库
  - **优先级**: P2
  - **预计时间**: 3 小时
  - **前置依赖**: TASK-055
  - **验收标准**:
    1. 组件测试覆盖率 ≥ 90%
    2. 模板加载测试通过
    3. 模板应用测试通过
  - **TDD 步骤**:
    1. 编写模板组件测试
    2. 实现模板选择器
    3. 实现模板应用逻辑
    4. 实现自定义模板
  - **测试用例**:
    - 测试选择模板
    - 测试应用模板到表单
    - 测试保存自定义模板
  - **交付物**:
    - `components/command-templates.tsx`
    - 预设模板配置

---

### 4.5 Job 管理界面

- [ ] **[前端]** TASK-058: 实现 Job 列表页面
  - **优先级**: P0
  - **预计时间**: 3 小时
  - **前置依赖**: TASK-048, TASK-051
  - **验收标准**:
    1. 组件测试覆盖率 ≥ 90%
    2. 列表渲染测试通过
    3. 过滤测试通过
  - **TDD 步骤**:
    1. 编写 Job 列表测试
    2. 实现 Job 列表 UI
    3. 实现过滤器
    4. 实现自动刷新
  - **测试用例**:
    - 测试 Job 列表渲染
    - 测试状态筛选
    - 测试时间排序
    - 测试自动刷新运行中 Job
  - **交付物**:
    - `app/jobs/page.tsx`
    - `components/job-table.tsx`

- [ ] **[前端]** TASK-059: 实现 Job 详情页面
  - **优先级**: P0
  - **预计时间**: 3 小时
  - **前置依赖**: TASK-058
  - **验收标准**:
    1. 组件测试覆盖率 ≥ 90%
    2. 详情展示测试通过
    3. 结果展示测试通过
  - **TDD 步骤**:
    1. 编写详情组件测试
    2. 实现 Job 详情 UI
    3. 实现结果展示
    4. 实现错误高亮
  - **测试用例**:
    - 测试 Job 信息展示
    - 测试按 Minion 分组结果
    - 测试错误信息高亮
    - 测试导出结果
  - **交付物**:
    - `app/jobs/[jid]/page.tsx`
    - `components/job-details.tsx`

---

### 4.6 Dashboard 界面

- [ ] **[前端]** TASK-060: 实现 Dashboard 统计卡片
  - **优先级**: P1
  - **预计时间**: 3 小时
  - **前置依赖**: TASK-048, TASK-051
  - **验收标准**:
    1. 组件测试覆盖率 ≥ 90%
    2. 数据加载测试通过
    3. 卡片渲染测试通过
  - **TDD 步骤**:
    1. 编写统计卡片测试
    2. 实现统计卡片组件
    3. 集成 Dashboard API
    4. 实现自动刷新
  - **测试用例**:
    - 测试统计数据显示
    - 测试加载状态
    - 测试错误处理
  - **交付物**:
    - `app/dashboard/page.tsx`
    - `components/stat-card.tsx`

- [ ] **[前端]** TASK-061: 实现 Dashboard 图表
  - **优先级**: P2
  - **预计时间**: 4 小时
  - **前置依赖**: TASK-060
  - **验收标准**:
    1. 组件测试覆盖率 ≥ 80%
    2. 图表渲染测试通过
    3. 交互测试通过
  - **TDD 步骤**:
    1. 编写图表组件测试
    2. 选择图表库（Recharts）
    3. 实现图表组件
    4. 验证数据绑定
  - **测试用例**:
    - 测试图表渲染
    - 测试数据更新
    - 测试交互（hover、click）
  - **交付物**:
    - `components/charts/` 目录
    - 各类图表组件

---

### 4.7 权限管理界面

- [ ] **[前端]** TASK-062: 实现用户列表页面
  - **优先级**: P1
  - **预计时间**: 3 小时
  - **前置依赖**: TASK-048, TASK-051
  - **验收标准**:
    1. 组件测试覆盖率 ≥ 90%
    2. 用户列表渲染测试通过
    3. 权限检查测试通过（仅超管）
  - **TDD 步骤**:
    1. 编写用户列表测试
    2. 实现用户列表 UI
    3. 实现角色显示
    4. 验证权限控制
  - **测试用例**:
    - 测试用户列表渲染
    - 测试角色标签显示
    - 测试非超管访问拒绝
  - **交付物**:
    - `app/permissions/users/page.tsx`
    - `components/user-list.tsx`

- [ ] **[前端]** TASK-063: 实现角色分配对话框
  - **优先级**: P1
  - **预计时间**: 3 小时
  - **前置依赖**: TASK-062
  - **验收标准**:
    1. 组件测试覆盖率 ≥ 90%
    2. 对话框测试通过
    3. 角色分配测试通过
  - **TDD 步骤**:
    1. 编写对话框测试
    2. 实现角色分配 UI
    3. 实现批量分配
    4. 验证操作确认
  - **测试用例**:
    - 测试打开对话框
    - 测试选择角色
    - 测试确认分配
    - 测试批量操作
  - **交付物**:
    - `components/assign-role-dialog.tsx`

---

### 4.8 审计日志界面

- [ ] **[前端]** TASK-064: 实现审计日志列表页面
  - **优先级**: P1
  - **预计时间**: 3 小时
  - **前置依赖**: TASK-048, TASK-051
  - **验收标准**:
    1. 组件测试覆盖率 ≥ 90%
    2. 日志列表渲染测试通过
    3. 过滤测试通过
  - **TDD 步骤**:
    1. 编写日志列表测试
    2. 实现日志列表 UI
    3. 实现多维度过滤
    4. 实现导出功能
  - **测试用例**:
    - 测试日志列表渲染
    - 测试按用户过滤
    - 测试按时间过滤
    - 测试导出 CSV
  - **交付物**:
    - `app/audit-logs/page.tsx`
    - `components/audit-log-table.tsx`

---

## Phase 5: 优化与测试 (Week 13-16)

### 5.1 性能优化

- [ ] **[优化]** TASK-065: 后端性能优化 - 数据库查询
  - **优先级**: P1
  - **预计时间**: 4 小时
  - **前置依赖**: TASK-036
  - **验收标准**:
    1. 查询性能提升 ≥ 50%
    2. N+1 问题解决
    3. 索引使用率 ≥ 90%
  - **TDD 步骤**:
    1. 编写性能基准测试
    2. 分析慢查询
    3. 优化查询逻辑
    4. 验证性能提升
  - **测试用例**:
    - 测试大数据量查询性能
    - 测试索引命中率
    - 测试连接池使用
  - **交付物**:
    - 性能优化报告
    - 查询优化代码

- [ ] **[优化]** TASK-066: 后端性能优化 - 缓存策略
  - **优先级**: P1
  - **预计时间**: 3 小时
  - **前置依赖**: TASK-065
  - **验收标准**:
    1. 缓存命中率 ≥ 80%
    2. 响应时间减少 ≥ 60%
    3. Redis 使用优化
  - **TDD 步骤**:
    1. 编写缓存测试
    2. 实现多级缓存
    3. 优化缓存失效策略
    4. 监控缓存性能
  - **测试用例**:
    - 测试缓存命中
    - 测试缓存更新
    - 测试缓存失效
  - **交付物**:
    - 缓存策略文档
    - 缓存监控指标

- [ ] **[优化]** TASK-067: 前端性能优化 - 代码分割
  - **优先级**: P1
  - **预计时间**: 3 小时
  - **前置依赖**: TASK-064
  - **验收标准**:
    1. 首屏加载时间 < 2 秒
    2. 代码分割配置正确
    3. Lighthouse 得分 ≥ 90
  - **TDD 步骤**:
    1. 分析打包体积
    2. 实现动态导入
    3. 配置路由懒加载
    4. 验证性能提升
  - **测试用例**:
    - 测试页面加载时间
    - 测试代码分割效果
    - 测试懒加载组件
  - **交付物**:
    - 打包优化配置
    - 性能报告

- [ ] **[优化]** TASK-068: 前端性能优化 - React优化
  - **优先级**: P1
  - **预计时间**: 3 小时
  - **前置依赖**: TASK-067
  - **验收标准**:
    1. 组件渲染次数减少 ≥ 50%
    2. memo/useMemo 使用正确
    3. 无性能警告
  - **TDD 步骤**:
    1. 分析组件渲染
    2. 使用 React DevTools Profiler
    3. 优化重渲染
    4. 验证性能提升
  - **测试用例**:
    - 测试组件重渲染次数
    - 测试 memo 效果
    - 测试列表渲染性能
  - **交付物**:
    - 优化后的组件
    - 性能对比报告

---

### 5.2 集成测试

- [ ] **[测试]** TASK-069: E2E 测试 - 认证流程
  - **优先级**: P1
  - **预计时间**: 3 小时
  - **前置依赖**: TASK-050
  - **验收标准**:
    1. E2E 测试通过
    2. 覆盖关键路径
    3. 测试稳定运行
  - **TDD 步骤**:
    1. 配置 Playwright
    2. 编写登录流程测试
    3. 编写登出流程测试
    4. 验证测试稳定性
  - **测试用例**:
    - 测试完整登录流程
    - 测试会话保持
    - 测试登出流程
  - **交付物**:
    - `e2e/auth.spec.ts`
    - Playwright 配置

- [ ] **[测试]** TASK-070: E2E 测试 - Minion 管理
  - **优先级**: P1
  - **预计时间**: 4 小时
  - **前置依赖**: TASK-054, TASK-069
  - **验收标准**:
    1. E2E 测试通过
    2. 覆盖主要操作
    3. 测试数据隔离
  - **TDD 步骤**:
    1. 编写 Minion 管理测试
    2. 编写 Key 管理测试
    3. 实现测试数据清理
    4. 验证测试幂等性
  - **测试用例**:
    - 测试查看 Minion 列表
    - 测试查看 Minion 详情
    - 测试接受 Key
    - 测试批量操作
  - **交付物**:
    - `e2e/minions.spec.ts`

- [ ] **[测试]** TASK-071: E2E 测试 - 命令执行
  - **优先级**: P1
  - **预计时间**: 4 小时
  - **前置依赖**: TASK-056, TASK-069
  - **验收标准**:
    1. E2E 测试通过
    2. 覆盖执行流程
    3. 结果验证正确
  - **TDD 步骤**:
    1. 编写命令执行测试
    2. 编写结果查看测试
    3. 实现异步等待
    4. 验证结果正确性
  - **测试用例**:
    - 测试执行简单命令
    - 测试查看执行结果
    - 测试实时更新
  - **交付物**:
    - `e2e/execution.spec.ts`

- [ ] **[测试]** TASK-072: 负载测试
  - **优先级**: P2
  - **预计时间**: 4 小时
  - **前置依赖**: TASK-066
  - **验收标准**:
    1. 负载测试场景定义
    2. 性能基线建立
    3. 瓶颈识别
  - **TDD 步骤**:
    1. 设计负载测试场景
    2. 配置 Locust/k6
    3. 执行负载测试
    4. 分析结果优化
  - **测试用例**:
    - 测试 100 并发用户
    - 测试 10000 Minion 查询
    - 测试并发命令执行
  - **交付物**:
    - 负载测试脚本
    - 性能测试报告

---

### 5.3 文档完善

- [ ] **[文档]** TASK-073: API 文档完善
  - **优先级**: P1
  - **预计时间**: 3 小时
  - **前置依赖**: TASK-043
  - **验收标准**:
    1. OpenAPI 文档完整
    2. 所有端点有描述
    3. 示例请求/响应完整
  - **交付物**:
    - OpenAPI 规范文件
    - Swagger UI 配置
    - API 使用指南

- [ ] **[文档]** TASK-074: 部署文档
  - **优先级**: P1
  - **预计时间**: 4 小时
  - **前置依赖**: TASK-004
  - **验收标准**:
    1. 部署步骤清晰
    2. 配置说明完整
    3. 故障排查指南
  - **交付物**:
    - `docs/deployment.md`
    - K8s 部署 YAML
    - Helm Chart

- [ ] **[文档]** TASK-075: 用户手册
  - **优先级**: P1
  - **预计时间**: 4 小时
  - **前置依赖**: TASK-064
  - **验收标准**:
    1. 功能说明完整
    2. 截图清晰
    3. 常见问题解答
  - **交付物**:
    - `docs/user-guide.md`
    - 功能截图
    - 视频教程（可选）

- [ ] **[文档]** TASK-076: 开发者文档
  - **优先级**: P1
  - **预计时间**: 3 小时
  - **前置依赖**: TASK-003
  - **验收标准**:
    1. 架构说明清晰
    2. 开发流程定义
    3. 代码规范文档
  - **交付物**:
    - `docs/developer-guide.md`
    - 架构图
    - 贡献指南

---

## Phase 6: 生产发布准备 (Week 17-18)

### 6.1 部署配置

- [ ] **[部署]** TASK-077: Kubernetes 部署配置
  - **优先级**: P0
  - **预计时间**: 4 小时
  - **前置依赖**: TASK-074
  - **验收标准**:
    1. Deployment 配置正确
    2. Service 配置正确
    3. ConfigMap 配置完整
    4. Secret 管理安全
  - **交付物**:
    - `k8s/` 目录
    - Deployment YAML
    - Service YAML
    - ConfigMap/Secret

- [ ] **[部署]** TASK-078: Helm Chart 打包
  - **优先级**: P0
  - **预计时间**: 4 小时
  - **前置依赖**: TASK-077
  - **验收标准**:
    1. Chart 结构正确
    2. Values 参数化
    3. 模板渲染正确
    4. Chart 可安装
  - **交付物**:
    - `charts/saltshark/` 目录
    - Chart.yaml
    - values.yaml
    - 模板文件

- [ ] **[部署]** TASK-079: CI/CD 流水线
  - **优先级**: P0
  - **预计时间**: 4 小时
  - **前置依赖**: TASK-078
  - **验收标准**:
    1. 自动构建配置
    2. 自动测试配置
    3. 自动部署配置
    4. 流水线测试通过
  - **交付物**:
    - `.github/workflows/` 目录
    - CI workflow
    - CD workflow
    - 发布 workflow

---

### 6.2 监控告警

- [ ] **[监控]** TASK-080: Prometheus 指标暴露
  - **优先级**: P1
  - **预计时间**: 3 小时
  - **前置依赖**: TASK-002
  - **验收标准**:
    1. 指标端点配置
    2. 关键指标定义
    3. 指标测试通过
  - **交付物**:
    - Prometheus 中间件
    - 自定义指标定义
    - Grafana Dashboard JSON

- [ ] **[监控]** TASK-081: 日志聚合配置
  - **优先级**: P1
  - **预计时间**: 3 小时
  - **前置依赖**: TASK-077
  - **验收标准**:
    1. 日志格式标准化
    2. Loki 配置正确
    3. 日志查询可用
  - **交付物**:
    - Promtail 配置
    - 日志格式定义
    - Grafana Loki 配置

- [ ] **[监控]** TASK-082: 告警规则配置
  - **优先级**: P1
  - **预计时间**: 2 小时
  - **前置依赖**: TASK-080
  - **验收标准**:
    1. 告警规则定义
    2. 告警通知配置
    3. 告警测试通过
  - **交付物**:
    - Prometheus 告警规则
    - AlertManager 配置
    - 告警通知模板

---

### 6.3 安全加固

- [ ] **[安全]** TASK-083: 安全扫描
  - **优先级**: P1
  - **预计时间**: 3 小时
  - **前置依赖**: TASK-079
  - **验收标准**:
    1. 依赖漏洞扫描通过
    2. 代码安全扫描通过
    3. 容器镜像扫描通过
  - **交付物**:
    - 安全扫描报告
    - 漏洞修复记录

- [ ] **[安全]** TASK-084: 渗透测试
  - **优先级**: P1
  - **预计时间**: 4 小时
  - **前置依赖**: TASK-083
  - **验收标准**:
    1. 渗透测试完成
    2. 高危漏洞修复
    3. 安全加固完成
  - **交付物**:
    - 渗透测试报告
    - 安全加固清单

---

### 6.4 发布准备

- [ ] **[发布]** TASK-085: 发布检查清单
  - **优先级**: P0
  - **预计时间**: 2 小时
  - **前置依赖**: TASK-084
  - **验收标准**:
    1. 所有测试通过
    2. 文档完整
    3. 发布流程定义
  - **交付物**:
    - 发布检查清单
    - 发布计划文档

- [ ] **[发布]** TASK-086: Beta 测试部署
  - **优先级**: P0
  - **预计时间**: 4 小时
  - **前置依赖**: TASK-085
  - **验收标准**:
    1. Beta 环境部署成功
    2. 用户反馈收集
    3. Bug 修复完成
  - **交付物**:
    - Beta 测试报告
    - Bug 修复记录

- [ ] **[发布]** TASK-087: 生产环境发布
  - **优先级**: P0
  - **预计时间**: 4 小时
  - **前置依赖**: TASK-086
  - **验收标准**:
    1. 生产环境部署成功
    2. 系统监控正常
    3. 用户培训完成
  - **交付物**:
    - v1.0 发布
    - 发布公告
    - 用户培训材料

---

## 附录

### 任务统计

- **总任务数**: 87 个
- **P0 任务**: 42 个（核心功能，必须完成）
- **P1 任务**: 38 个（重要功能，MVP 需要）
- **P2 任务**: 5 个（增强功能，可延后）
- **P3 任务**: 2 个（优化功能，可选）
- **预估总工时**: 约 280-300 小时（1.5-2 人月）

### 关键路径

```
TASK-001 → TASK-002 → TASK-005-009 → TASK-010 → TASK-013-015
  ↓
TASK-019-023 (Salt API)
  ↓
TASK-024-030 (Minion Management)
  ↓
TASK-031-036 (Job Management)
  ↓
TASK-046-051 (Frontend Infrastructure)
  ↓
TASK-052-059 (Frontend Core Features)
  ↓
TASK-065-068 (Performance Optimization)
  ↓
TASK-069-072 (Testing)
  ↓
TASK-077-079 (Deployment)
  ↓
TASK-087 (Production Release)
```

### 并行开发建议

可以并行开发的任务组：

1. **数据库层** (TASK-005-009) 与 **认证层** (TASK-010-015) 可并行
2. **Salt API 集成** (TASK-019-023) 与 **用户系统** (TASK-016-018) 可并行
3. **Minion Service** (TASK-024-030) 与 **Job Service** (TASK-031-036) 可并行
4. **前端基础** (TASK-046-051) 可与后端开发并行启动
5. **前端页面** (TASK-052-064) 各模块可并行开发
6. **性能优化** (TASK-065-068) 与 **E2E 测试** (TASK-069-072) 可并行

---

**文档结束**

**下一步**: 按照优先级和依赖关系，从 TASK-001 开始逐个完成任务。每个任务完成后，运行完整的测试套件，确保不引入回归问题。

