# SaltShark 产品需求文档 (PRD)

## 1. 项目概述

### 1.1 产品定位

SaltShark 是一个现代化的 Web 管理界面，为 Salt Project（前 SaltStack）提供可视化的运维管理能力。Salt Project 是业界领先的基础设施自动化和配置管理平台，而 SaltShark 旨在降低其使用门槛，提供直观、高效的管理体验。

**目标规模**: 管理 1,000-10,000 台 Minion  
**部署环境**: 私有云 Kubernetes 集群  
**架构模式**: 支持 Salt Master 高可用（三节点）集群

### 1.2 核心价值

- **可视化管理**: 提供直观的 Web 界面管理 Salt 基础设施
- **细粒度权限控制**: 实现基于关系的访问控制（ReBAC）
- **实时监控**: 实时查看 Minion 状态和执行结果
- **安全合规**: 支持审计日志，满足企业安全要求
- **易于扩展**: 模块化架构，便于功能扩展

### 1.3 目标用户

- **运维工程师**: 日常管理和维护 Salt 基础设施
- **DevOps 团队**: 自动化部署和配置管理
- **系统管理员**: 大规模服务器管理和监控
- **安全管理员**: 权限管理和审计

---

## 2. 功能需求

### 2.1 核心功能模块

#### 2.1.1 Minion 管理

**功能描述**:
管理所有受控节点（Minion），查看其状态、配置和运行信息。

**详细需求**:

1. **Minion 列表**
   - 显示所有 Minion 的列表视图
   - 支持分页、排序和搜索
   - 显示关键信息：主机名、IP 地址、操作系统、在线状态
   - 支持按状态筛选（在线/离线/未响应）
   - 支持按标签（Grains）筛选

2. **Minion 详情**
   - 查看 Minion 的详细信息
   - Grains 数据展示（系统信息、硬件配置）
   - Pillar 数据展示（配置数据）
   - 历史执行记录
   - 实时日志查看

3. **Minion 操作**
   - 接受/拒绝 Minion Key（首次连接认证）
   - 删除 Minion Key
   - 重启 Minion 服务
   - 测试连通性（test.ping）
   - 批量操作支持

#### 2.1.2 远程执行（Remote Execution）

**功能描述**:
在目标 Minion 上执行命令、脚本或 Salt 模块。

**详细需求**:

1. **命令执行界面**
   - 可视化命令构建器
   - 支持 Salt 模块选择（cmd.run、pkg.install 等）
   - 参数输入和验证
   - 目标选择器（Targeting）
     - 按 Minion ID 匹配
     - 按 Glob 模式匹配
     - 按 Grains 匹配
     - 按 Pillar 匹配
     - 按 Compound 匹配（组合条件）

2. **执行结果展示**
   - 实时显示执行进度
   - 按 Minion 分组显示结果
   - 支持成功/失败状态标识
   - 结果导出（JSON/CSV/TXT）
   - 错误信息高亮

3. **执行历史**
   - 记录所有执行命令
   - 支持重新执行历史命令
   - 执行审计日志
   - 性能统计（执行时间、成功率）

#### 2.1.3 Job 管理

**功能描述**:
管理和监控所有 Salt Job（任务）的执行状态。

**详细需求**:

1. **Job 列表**
   - 显示所有 Job 的列表
   - 显示信息：Job ID、命令、目标、状态、开始时间
   - 支持按状态筛选（运行中/成功/失败）
   - 支持按时间范围筛选
   - 自动刷新运行中的 Job

2. **Job 详情**
   - 查看 Job 的完整信息
   - 执行参数详情
   - 每个 Minion 的执行结果
   - 执行时间线
   - 标准输出和错误输出

3. **Job 控制**
   - 终止运行中的 Job
   - 查看 Job 的实时进度
   - 重新执行失败的 Job

#### 2.1.4 Dashboard 仪表盘

**功能描述**:
提供 Salt 基础设施的整体概览和关键指标。

**详细需求**:

1. **实时统计**
   - Minion 总数和在线率
   - 当前运行的 Job 数量
   - 最近执行的任务统计
   - 系统资源使用情况（可选）

2. **健康状态**
   - Salt Master 状态
   - Minion 连接状态分布
   - 最近失败的任务
   - 告警信息（可选）

3. **快速操作**
   - 常用命令快捷入口
   - 最近使用的 Minion
   - 收藏的操作模板

### 2.2 权限管理

**功能描述**:
实现细粒度的权限控制，确保用户只能访问和操作授权的资源。

**详细需求**:

#### 2.2.1 权限模型

**单租户架构** - 无组织层级，所有用户共享同一个权限域。

**预设角色**:
1. **超级管理员** (super_admin): 所有权限，包括权限管理
2. **运维人员** (operator): 执行命令、管理 Minion、管理 Job
3. **只读用户** (viewer): 只能查看，不能执行操作

**权限继承规则**:
```
超级管理员 (super_admin)
  ├─ 所有 minion 的管理权限
  ├─ 所有 job 的执行/终止权限
  └─ 权限管理能力

运维人员 (operator)
  ├─ 所有 minion 的操作权限
  └─ 所有 job 的执行/终止权限

只读用户 (viewer)
  ├─ 所有 minion 的查看权限
  └─ 所有 job 的查看权限
```

#### 2.2.2 初始化配置

**首个超级管理员设置**:
- 通过配置文件指定初始超级管理员的用户ID
- 可配置多个初始超管
- 应用启动时自动创建权限关系

#### 2.2.3 权限检查

**功能要求**:
1. **请求拦截**: 在所有 API 端点前进行权限检查
2. **资源过滤**: 列表接口只返回用户有权限的资源
3. **操作验证**: 操作前验证用户对特定资源的权限
4. **审计日志**: 记录所有权限检查和授权变更

#### 2.2.4 权限管理界面

**超级管理员手动分配权限** - 在 Web 界面上操作。

**权限管理页面功能**:

1. **用户列表**:
   - 显示所有已登录过的用户
   - 显示每个用户当前的角色
   - 支持搜索和筛选

2. **角色分配**:
   - 选择用户
   - 分配角色：超级管理员 / 运维人员 / 只读用户
   - 支持批量分配

3. **权限变更历史**:
   - 记录谁在什么时候修改了谁的权限
   - 审计日志

#### 2.2.5 用户信息获取

**需求说明**:
- SaltShark 不实现用户管理功能
- 用户管理由外部系统负责
- **SaltShark 数据库只存储用户 ID**
- 用户的其他信息（姓名、邮箱、部门等）通过用户管理系统 API 实时获取

**用户信息集成要求**:
1. **认证流程**: 通过 SSO 获取用户ID
2. **本地存储**: 只存储用户ID和活跃时间
3. **实时获取**: 通过API获取用户详细信息（姓名、邮箱等）
4. **缓存策略**: 使用缓存减少API调用，提高性能
5. **批量查询**: 支持批量获取多个用户信息

### 2.3 审计日志

**功能描述**:
记录所有关键操作，满足合规和安全要求。

**详细需求**:

1. **日志记录内容**
   - 操作时间戳
   - 用户 ID（操作者）
   - 操作类型（执行命令、管理 Key、权限变更）
   - 目标资源（Minion ID、Job ID）
   - 操作参数
   - 执行结果（成功/失败）
   - 客户端 IP 地址

2. **日志查询**
   - 按时间范围筛选
   - 按用户筛选
   - 按操作类型筛选
   - 按资源筛选
   - 全文搜索

3. **日志导出**
   - 支持导出为 CSV/JSON
   - 支持定期归档
   - 集成到 SIEM 系统（可选）

---

## 3. 非功能需求

### 3.1 性能要求

- **响应时间**: 
  - 页面加载时间 < 2 秒（首屏加载）
  - API 响应时间 < 500ms（P95）
  - 权限检查延迟 < 50ms
  - Minion 列表渲染 < 1 秒（1000+ 条记录）
  
- **并发能力**:
  - 支持 100+ 并发用户（运维团队规模）
  - 管理 1,000-10,000 台 Minion
  - 支持同时执行 50+ Job（跨多个 Minion）
  - Salt API 请求并发：200+ QPS

- **可扩展性**:
  - 水平扩展：无状态后端服务，可自动扩展
  - 高可用支持：对接 Salt Master 三节点集群
  - 数据库：支持主从复制（读写分离）
  - 缓存：支持 Redis 集群

- **大规模优化**:
  - Minion 列表分页（每页 50-100 条）
  - 使用缓存存储 Minion 状态
  - Job 结果异步写入，避免阻塞
  - 批量操作限流（单次最多 100 个 Minion）

### 3.2 安全要求

- **认证**: 
  - 单点登录（SSO）
  - OAuth2/OIDC 协议
  - 支持多因素认证（MFA）
  - 会话管理和超时控制

- **授权**:
  - 细粒度权限控制
  - 最小权限原则
  - 权限变更审计

- **通信安全**:
  - 所有 API 通信必须使用 HTTPS
  - Salt API 通信使用 SSL/TLS
  - 敏感数据加密存储

- **数据保护**:
  - 敏感配置数据脱敏
  - 密码和密钥使用加密存储
  - 定期安全扫描和漏洞修复

### 3.3 可用性要求

- **系统可用性**: 99.9%（三个九）
- **故障恢复**: RTO < 1 小时，RPO < 24 小时
- **容错能力**: 单个组件故障不影响核心功能
- **数据备份**: 
  - 备份管理由专职 DBA 团队负责
  - 备份范围：PostgreSQL 数据库（业务数据、审计日志）
  - 备份策略：按照公司统一的数据库备份标准执行
  - SaltShark 责任：提供数据库连接信息和备份窗口建议

### 3.4 可维护性要求

- **代码质量**:
  - 遵循代码规范
  - 测试覆盖率 ≥ 80%
  - 所有公共 API 有完整文档

- **界面语言**: 
  - 仅支持中文，无需国际化（i18n）
  - 简化开发和维护成本
  - 所有界面文案、错误提示、日志均使用中文

- **监控和告警**:
  - 应用性能监控（APM）
  - 错误日志聚合
  - 关键指标告警

- **部署**:
  - 容器化部署
  - 自动化 CI/CD 流程
  - 滚动更新和金丝雀发布

---

## 4. 实施计划

### 4.1 开发阶段

**Phase 1: MVP（最小可行产品）- 6 周**
- Week 1-2: 项目初始化和架构搭建
  - 开发环境配置
  - 后端框架搭建
  - 前端框架搭建
  - 集成测试

- Week 3-4: 核心功能开发
  - Minion 列表和详情查看
  - Minion Key 管理（接受/拒绝/删除）
  - 基本远程执行（cmd.run）
  - 简单的 Dashboard

- Week 5-6: 权限和安全
  - 权限模型实现
  - 用户认证集成
  - 基本权限检查
  - 审计日志

**Phase 2: 完整功能 - 8 周**
- Week 7-9: 高级执行功能
  - 多种 Targeting 方式
  - 常用 Salt 模块支持
  - 命令模板库
  - 执行历史和重试

- Week 10-12: Job 管理
  - Job 列表和详情
  - 实时 Job 状态
  - Job 控制（终止、重试）
  - Job 性能统计

- Week 13-14: 权限增强
  - 细粒度权限控制
  - 权限管理界面
  - 权限委托

**Phase 3: 优化和发布 - 4 周**
- Week 15-16: 性能优化
  - 缓存策略优化
  - 数据库查询优化
  - 前端性能优化
  - 负载测试

- Week 17-18: 生产准备
  - 监控和告警
  - 部署文档
  - 用户手册
  - Beta 测试

### 4.2 里程碑

| 里程碑 | 目标 | 交付物 | 时间 |
|--------|------|--------|------|
| M1: 项目启动 | 完成架构设计和技术选型 | 技术方案文档、POC | Week 2 |
| M2: MVP 完成 | 基本功能可用 | MVP 版本、演示环境 | Week 6 |
| M3: 功能完整 | 所有核心功能完成 | Beta 版本、测试报告 | Week 14 |
| M4: 生产发布 | 正式版本发布 | v1.0 版本、部署指南 | Week 18 |

---

## 5. 风险和挑战

### 5.1 技术风险

**风险 1: Salt API 性能瓶颈**
- **描述**: 大规模 Minion 环境下 Salt API 响应慢
- **缓解措施**: 
  - 实现缓存层减少 API 调用
  - 使用异步处理长时间操作
  - 考虑直接连接 Salt Event Bus

**风险 2: 权限集成复杂度**
- **描述**: 权限模型设计和集成可能比预期复杂
- **缓解措施**:
  - 早期 POC 验证权限模型
  - 参考最佳实践和官方示例
  - 逐步实施权限功能

**风险 3: 实时通信稳定性**
- **描述**: WebSocket 连接在复杂网络环境下可能不稳定
- **缓解措施**:
  - 实现降级方案（轮询）
  - 使用成熟的 WebSocket 库
  - 实现断线重连机制

### 5.2 业务风险

**风险 4: 用户采用度**
- **描述**: 运维人员可能习惯命令行，不愿使用 Web 界面
- **缓解措施**:
  - 提供 CLI 到 Web 的迁移指南
  - 强调可视化和权限管理的优势
  - 收集用户反馈持续改进

**风险 5: 功能范围蔓延**
- **描述**: 需求不断增加导致项目延期
- **缓解措施**:
  - 严格控制 MVP 范围
  - 使用敏捷开发方法
  - 定期评审和调整优先级

### 5.3 安全风险

**风险 6: 权限绕过漏洞**
- **描述**: 权限检查实现不当导致安全问题
- **缓解措施**:
  - 所有 API 端点强制权限检查
  - 定期安全审计
  - 实施渗透测试

**风险 7: Salt Master 访问控制**
- **描述**: SaltShark 对 Salt Master 的访问可能成为攻击面
- **缓解措施**:
  - 使用最小权限的 Salt API 账户
  - 限制 SaltShark 可执行的 Salt 函数
  - 实施 IP 白名单

---

## 6. 成功指标

### 6.1 技术指标

- **性能**:
  - API P95 响应时间 < 500ms
  - 页面加载时间 < 2 秒
  - 支持 10,000+ Minion 管理

- **质量**:
  - 测试覆盖率 ≥ 80%
  - 无 P0/P1 级别 bug
  - 代码审查通过率 100%

- **可靠性**:
  - 系统可用性 ≥ 99.9%
  - 零数据丢失
  - RTO < 1 小时

### 6.2 业务指标

- **用户采用**:
  - 首个季度活跃用户 ≥ 50
  - 用户满意度 ≥ 4.0/5.0
  - 日活跃率 ≥ 30%

- **效率提升**:
  - 运维操作时间减少 40%
  - 权限管理效率提升 60%
  - 减少人为操作错误 50%

---

## 7. 附录

### 7.1 术语表

| 术语 | 定义 |
|------|------|
| Salt Master | Salt 的中央控制服务器，负责向 Minion 发送命令 |
| Salt Minion | 受 Salt Master 管理的节点，执行 Master 发送的命令 |
| Grains | Minion 的静态信息（操作系统、硬件配置等） |
| Pillar | 针对特定 Minion 的配置数据 |
| State | Salt 配置管理的声明式定义 |
| Targeting | 选择执行命令的目标 Minion 的方法 |
| Job | Salt 执行任务的实例，包含命令和结果 |
| ReBAC | Relationship-Based Access Control，基于关系的访问控制 |

---

**文档结束**
